<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner de QR Code Tropitech</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <style>
        body {
            background-color: #121212;
            color: white;
        }
        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        #qr-reader__scan_region {
            background: black;
        }
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 255, 0, 0.5);
            display: none;
        }
        .container {
            max-width: 600px;
        }
        .valid-badge {
            background-color: rgba(16, 185, 129, 0.7);
        }
        .invalid-badge {
            background-color: rgba(239, 68, 68, 0.7);
        }
        .settings-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .settings-panel.open {
            max-height: 500px;
        }
        /* Personnalisation pour Tropitech */
        .tropitech-bg {
            background: linear-gradient(to bottom right, #1e1e1e, #2d1e2f);
        }
        .loading-spinner {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .blink {
            animation: blink-animation 1s steps(5, start) infinite;
        }
        @keyframes blink-animation {
            to { visibility: hidden; }
        }
    </style>
</head>
<body class="tropitech-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">Scanner Tropitech</h1>
            <button id="settingsBtn" class="px-4 py-2 bg-purple-800 rounded-lg hover:bg-purple-700 transition duration-300">
                ⚙️ Paramètres
            </button>
        </div>

        <div id="settingsPanel" class="settings-panel bg-gray-900 rounded-lg p-5 mb-6">
            <h2 class="text-xl font-bold mb-4">Paramètres de connexion</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">URL de l'API</label>
                <input type="text" id="apiUrlInput" placeholder="https://votre-api.com" 
                       class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Clé d'API (optionnelle)</label>
                <input type="password" id="apiKeyInput" placeholder="Votre clé d'API" 
                       class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="testConnectionBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Tester la connexion
                </button>
                <button id="saveSettingsBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    Enregistrer
                </button>
            </div>
            <div id="connectionStatus" class="mt-3 text-center hidden"></div>
        </div>

        <div id="loginPanel" class="bg-gray-900 rounded-lg p-6 text-center">
            <h2 class="text-xl font-bold mb-4">Connectez-vous pour commencer</h2>
            <p class="mb-4">Veuillez configurer les paramètres de connexion à l'API pour pouvoir scanner des billets</p>
            <button id="showSettingsBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                Configurer l'API
            </button>
        </div>

        <div id="mainPanel" class="hidden">
            <div class="bg-gray-900 rounded-lg p-6 mb-6">
                <div id="qr-reader"></div>
                <div class="scanner-overlay" id="scannerOverlay"></div>
                <div class="mt-4 text-center">
                    <p class="text-gray-400">Placez le QR code dans le cadre pour scanner</p>
                </div>
            </div>

            <div id="lastScanResult" class="bg-gray-900 rounded-lg p-6 hidden">
                <h2 class="text-xl font-bold mb-4">Résultat du scan</h2>
                <div id="scanStatus" class="mb-4 p-3 rounded-lg text-center"></div>
                <div id="ticketDetails" class="space-y-3">
                    <!-- Le contenu sera rempli dynamiquement -->
                </div>
            </div>

            <div id="scanHistory" class="bg-gray-900 rounded-lg p-6 mt-6">
                <h2 class="text-xl font-bold mb-4">Historique des scans (session actuelle)</h2>
                <div class="overflow-hidden rounded-lg border border-gray-700">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-800">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Heure</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Nom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Statut</th>
                            </tr>
                        </thead>
                        <tbody id="scanHistoryBody" class="bg-gray-900 divide-y divide-gray-700">
                            <!-- Les entrées seront ajoutées dynamiquement -->
                        </tbody>
                    </table>
                </div>
                <p id="noScansMessage" class="text-center py-4 text-gray-400">Aucun scan effectué</p>
            </div>
        </div>
    </div>

    <script>
        // État de l'application
        const appState = {
            apiUrl: localStorage.getItem('apiUrl') || '',
            apiKey: localStorage.getItem('apiKey') || '',
            isConnected: false,
            scannedTickets: {},
            scanHistory: []
        };

        // Éléments DOM
        const elements = {
            settingsBtn: document.getElementById('settingsBtn'),
            settingsPanel: document.getElementById('settingsPanel'),
            apiUrlInput: document.getElementById('apiUrlInput'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            testConnectionBtn: document.getElementById('testConnectionBtn'),
            connectionStatus: document.getElementById('connectionStatus'),
            loginPanel: document.getElementById('loginPanel'),
            showSettingsBtn: document.getElementById('showSettingsBtn'),
            mainPanel: document.getElementById('mainPanel'),
            lastScanResult: document.getElementById('lastScanResult'),
            scanStatus: document.getElementById('scanStatus'),
            ticketDetails: document.getElementById('ticketDetails'),
            scannerOverlay: document.getElementById('scannerOverlay'),
            scanHistoryBody: document.getElementById('scanHistoryBody'),
            noScansMessage: document.getElementById('noScansMessage')
        };

        // Initialisation
        function init() {
            // Charger les paramètres enregistrés
            if (appState.apiUrl) {
                elements.apiUrlInput.value = appState.apiUrl;
                elements.apiKeyInput.value = appState.apiKey;
                
                // Tester automatiquement la connexion
                testConnection().then(isConnected => {
                    if (isConnected) {
                        showMainPanel();
                        initQRScanner();
                    } else {
                        showLoginPanel();
                    }
                });
            } else {
                showLoginPanel();
            }

            // Gestionnaires d'événements
            elements.settingsBtn.addEventListener('click', toggleSettingsPanel);
            elements.showSettingsBtn.addEventListener('click', toggleSettingsPanel);
            elements.saveSettingsBtn.addEventListener('click', saveSettings);
            elements.testConnectionBtn.addEventListener('click', async () => {
                await testConnection();
            });
        }

        // Afficher/masquer le panneau des paramètres
        function toggleSettingsPanel() {
            elements.settingsPanel.classList.toggle('open');
        }

        // Enregistrer les paramètres
        async function saveSettings() {
            const apiUrl = elements.apiUrlInput.value.trim();
            const apiKey = elements.apiKeyInput.value.trim();
            
            if (!apiUrl) {
                alert("L'URL de l'API est requise");
                return;
            }
            
            appState.apiUrl = apiUrl;
            appState.apiKey = apiKey;
            
            localStorage.setItem('apiUrl', apiUrl);
            localStorage.setItem('apiKey', apiKey);
            
            const isConnected = await testConnection();
            
            if (isConnected) {
                toggleSettingsPanel();
                showMainPanel();
                initQRScanner();
            }
        }

        // Tester la connexion à l'API
        async function testConnection() {
            const apiUrl = elements.apiUrlInput.value.trim() || appState.apiUrl;
            const apiKey = elements.apiKeyInput.value.trim() || appState.apiKey;
            
            if (!apiUrl) {
                return false;
            }
            
            elements.connectionStatus.innerHTML = '<div class="loading-spinner"></div><p>Test de connexion en cours...</p>';
            elements.connectionStatus.classList.remove('hidden');
            
            try {
                const healthEndpoint = `${apiUrl}/health`;
                const headers = {};
                
                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }
                
                const response = await fetch(healthEndpoint, { headers });
                
                if (response.ok) {
                    const data = await response.json();
                    elements.connectionStatus.innerHTML = '<div class="bg-green-800 rounded-lg p-3 mt-3">✅ Connexion réussie !</div>';
                    appState.isConnected = true;
                    return true;
                } else {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Erreur de connexion:', error);
                elements.connectionStatus.innerHTML = `<div class="bg-red-800 rounded-lg p-3 mt-3">❌ Erreur de connexion: ${error.message}</div>`;
                appState.isConnected = false;
                return false;
            }
        }

        // Afficher le panneau principal
        function showMainPanel() {
            elements.loginPanel.classList.add('hidden');
            elements.mainPanel.classList.remove('hidden');
        }

        // Afficher le panneau de connexion
        function showLoginPanel() {
            elements.loginPanel.classList.remove('hidden');
            elements.mainPanel.classList.add('hidden');
        }

        // Initialiser le scanner de QR code
        function initQRScanner() {
            const html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                onQRCodeSuccess, 
                onQRCodeError
            ).catch(err => {
                console.error("Erreur lors du démarrage de la caméra:", err);
                alert("Impossible d'accéder à la caméra. Vérifiez les permissions.");
            });

            function onQRCodeSuccess(decodedText) {
                console.log("QR Code détecté:", decodedText);
                processQRCode(decodedText, html5QrCode);
            }

            function onQRCodeError(error) {
                // Ignorer les erreurs de décodage courantes
                // console.error("Erreur de scan:", error);
            }
        }

        // Traiter le QR code scanné
        async function processQRCode(qrData, scanner) {
            // Pause temporaire du scanner pour éviter les scans multiples
            scanner.pause();
            
            // Afficher un overlay vert pendant le scan
            elements.scannerOverlay.style.display = 'block';
            
            try {
                // Vérifier si le QR code a déjà été scanné localement (double scan protection)
                if (appState.scannedTickets[qrData]) {
                    displayScanResult({
                        isValid: false,
                        status: 'ALREADY_SCANNED',
                        message: 'Ce billet a déjà été scanné',
                        ticket: appState.scannedTickets[qrData]
                    });
                    return;
                }
                
                // Essayer d'extraire l'ID du billet du QR code
                let ticketId = qrData;
                
                // Si le QR code est une URL, extraire l'ID du billet
                if (qrData.includes('/ticket/')) {
                    const parts = qrData.split('/ticket/');
                    if (parts.length > 1) {
                        ticketId = parts[1];
                    }
                }
                
                // Vérifier le billet avec l'API
                const response = await fetch(`${appState.apiUrl}/api/ticket/validate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(appState.apiKey ? { 'Authorization': `Bearer ${appState.apiKey}` } : {})
                    },
                    body: JSON.stringify({ ticketId, scanData: qrData })
                });
                
                if (!response.ok) {
                    // Simuler une réponse pour les tests si l'API n'existe pas encore
                    if (response.status === 404) {
                        console.log("API de validation non trouvée, simulation de réponse pour les tests");
                        
                        // Vérification manuelle du format de l'ID de billet (commence par "pi_")
                        const isProbablyTicket = ticketId.startsWith('pi_') || ticketId.match(/^[a-zA-Z0-9_]{20,30}$/);
                        
                        // Simulation d'un billet valide ou invalide de manière aléatoire pour les tests
                        const mockResponse = {
                            isValid: isProbablyTicket,
                            status: isProbablyTicket ? 'VALID' : 'INVALID_FORMAT',
                            message: isProbablyTicket ? 'Billet valide (SIMULATION)' : 'Format de billet invalide (SIMULATION)',
                            ticket: isProbablyTicket ? {
                                paymentId: ticketId,
                                name: 'Doe',
                                firstName: 'John',
                                email: 'john.doe@example.com',
                                category: ['earlyBird', 'secondRelease', 'thirdRelease'][Math.floor(Math.random() * 3)],
                                createdAt: new Date().toISOString()
                            } : null
                        };
                        
                        displayScanResult(mockResponse);
                        
                        // Enregistrer le billet comme scanné (pour la simulation)
                        if (isProbablyTicket) {
                            appState.scannedTickets[qrData] = mockResponse.ticket;
                            addToScanHistory(mockResponse);
                        }
                        
                        return;
                    }
                    
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Afficher le résultat du scan
                displayScanResult(result);
                
                // Si le billet est valide, l'ajouter à la liste des billets scannés
                if (result.isValid) {
                    appState.scannedTickets[qrData] = result.ticket;
                    addToScanHistory(result);
                }
                
            } catch (error) {
                console.error('Erreur lors de la validation du billet:', error);
                
                displayScanResult({
                    isValid: false,
                    status: 'ERROR',
                    message: `Erreur: ${error.message}`,
                    ticket: null
                });
            } finally {
                // Retirer l'overlay après un court délai
                setTimeout(() => {
                    elements.scannerOverlay.style.display = 'none';
                    scanner.resume();
                }, 1500);
            }
        }

        // Afficher le résultat du scan
        function displayScanResult(result) {
            elements.lastScanResult.classList.remove('hidden');
            
            // Définir le statut
            const scanStatus = elements.scanStatus;
            scanStatus.innerHTML = '';
            scanStatus.classList.remove('valid-badge', 'invalid-badge');
            
            if (result.isValid) {
                scanStatus.classList.add('valid-badge');
                scanStatus.innerHTML = `
                    <div class="flex items-center justify-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-lg font-bold">VALIDE</span>
                    </div>
                    <p>${result.message || 'Billet accepté'}</p>
                `;
                
                // Jouer un son de succès
                playSound('success');
            } else {
                scanStatus.classList.add('invalid-badge');
                
                let statusIcon, statusText;
                
                switch (result.status) {
                    case 'ALREADY_SCANNED':
                        statusIcon = '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                        statusText = 'DÉJÀ SCANNÉ';
                        break;
                    case 'INVALID_FORMAT':
                        statusIcon = '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                        statusText = 'INVALIDE';
                        break;
                    default:
                        statusIcon = '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                        statusText = 'REFUSÉ';
                }
                
                scanStatus.innerHTML = `
                    <div class="flex items-center justify-center">
                        ${statusIcon}
                        <span class="text-lg font-bold blink">${statusText}</span>
                    </div>
                    <p>${result.message || 'Billet invalide'}</p>
                `;
                
                // Jouer un son d'erreur
                playSound('error');
            }
            
            // Afficher les détails du billet
            const ticketDetails = elements.ticketDetails;
            ticketDetails.innerHTML = '';
            
            if (result.ticket) {
                const ticket = result.ticket;
                const formattedDate = new Date(ticket.createdAt).toLocaleDateString('fr-FR', { 
                    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                
                const categoryLabels = {
                    'earlyBird': 'Early Bird',
                    'secondRelease': 'Second Release',
                    'thirdRelease': 'Third Release'
                };
                
                ticketDetails.innerHTML = `
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <div class="mb-2">
                            <span class="text-gray-400">Nom:</span>
                            <span class="font-bold">${ticket.firstName} ${ticket.name}</span>
                        </div>
                        <div class="mb-2">
                            <span class="text-gray-400">Email:</span>
                            <span>${ticket.email}</span>
                        </div>
                        <div class="mb-2">
                            <span class="text-gray-400">Catégorie:</span>
                            <span class="font-bold">${categoryLabels[ticket.category] || ticket.category}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Date d'achat:</span>
                            <span>${formattedDate}</span>
                        </div>
                        <div class="mt-2">
                            <span class="text-gray-400">ID:</span>
                            <span class="text-xs">${ticket.paymentId || 'N/A'}</span>
                        </div>
                    </div>
                `;
            }
        }

        // Ajouter un scan à l'historique
        function addToScanHistory(result) {
            // Mettre à jour l'historique des scans
            const ticket = result.ticket;
            if (!ticket) return;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const scanEntry = {
                time: timeString,
                ticket: ticket,
                isValid: result.isValid,
                status: result.status
            };
            
            appState.scanHistory.unshift(scanEntry);
            updateScanHistoryUI();
        }

        // Mettre à jour l'interface de l'historique des scans
        function updateScanHistoryUI() {
            const historyBody = elements.scanHistoryBody;
            
            if (appState.scanHistory.length === 0) {
                elements.noScansMessage.classList.remove('hidden');
                return;
            }
            
            elements.noScansMessage.classList.add('hidden');
            historyBody.innerHTML = '';
            
            appState.scanHistory.forEach(entry => {
                const row = document.createElement('tr');
                
                const statusClass = entry.isValid ? 'bg-green-800 text-white' : 'bg-red-800 text-white';
                const statusText = entry.isValid ? 'VALIDE' : 
                    (entry.status === 'ALREADY_SCANNED' ? 'DÉJÀ SCANNÉ' : 'INVALIDE');
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${entry.time}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${entry.ticket.firstName} ${entry.ticket.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${statusText}</span>
                    </td>
                `;
                
                historyBody.appendChild(row);
            });
        }

        // Jouer un son
        function playSound(type) {
            try {
                const audio = new Audio();
                audio.src = type === 'success' 
                    ? 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAABPAAMzMzMzMzMzMzMzMzMzMzMzMzMzOZmZmZmZmZmZmZmZmZmZmZmZmZmZnMzMzMzMzMzMzMzMzMzMzMzMzMzMz///////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAYkAAAAAAAA8MCFkc6QAAAAAAAAAAAAAAAAAAAAAP/jeMAAAAAAAAAAAABNYXRyb3NrYQAAAFhJbmZvAAAADwAAAAMAAAk7ADMzMzMzMzMzMzMzMzMzMzMzMzMzmZmZmZmZmZmZmZmZmZmZmZmZmZmZzMzMzMzMzMzMzMzMzMzMzMzMzMzM////////////////////////////////////////////AAAAAExhdmM1OC4xMwAAAAAAAAAAAAAkBgoAAAAAAAAJO7GILUkAAAAAAAAAAAAAAAAAQgD/+9DEAAAGkAN/tBAAL5QQreZ2gAUAJAG1a3XO3773S7WO1rGkMYcbvGCKnTsYQfvh/CAIAgCYg+D4fD8MCDweBAEJDjg8UGJZUuuEBDiw5UcJlEAhI8QDHlwxw+GJYbD4OCHHi6WAwQZHnAgkeDBiOFx/+Z7o5Id85UuSzx8fIJGlpYuNlf7///5QfKD8PKD5sMsDweBAEwfD4fh+GAQBAEgQBAEg+H4QPh5QBAEAQBAEAQAsAAAmYQGACBSIUH////////v//+gIBkCQ2IGQ2ICIMgIC//sCYMIYPhgTB8PmxPh+GD7//4Pm/8Hw/Dw/D62GBANyAoDgQcCAIAgCHgQBBgCHgQBM+oEAQ+D4fhgQBAEPgg+D4fmA+GBAEP/CAIOA+D1sQBoIABQAeAIKgcD4YwPiGAOAZh//t